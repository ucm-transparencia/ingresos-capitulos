<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ingresos por Cap√≠tulos 2024 ‚Äî UCM</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #e8e8e8 100%); padding: 20px; min-height: 100vh; }
  .container { max-width: 100%; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); overflow: hidden; }
  .header { background: linear-gradient(135deg, #b71234 0%, #8b0d27 100%); color: white; padding: 16px 30px; }
  .header h1 { font-size: 22px; font-weight: 400; margin: 0; }

  /* Barra de descarga */
  .download-bar { padding: 14px 30px; background: #fff; border-bottom: 2px solid #e9ecef; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
  .download-bar span { font-weight: 600; color: #2f2f2f; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
  .dl-btn { display: inline-flex; align-items: center; gap: 7px; padding: 9px 18px; border: none; border-radius: 7px; font-weight: 600; font-size: 13px; cursor: pointer; transition: all 0.3s; font-family: inherit; }
  .dl-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
  .dl-btn.xlsx { background: #1D6F42; color: white; }
  .dl-btn.csv  { background: #217346; color: white; }
  .dl-btn svg  { width: 16px; height: 16px; flex-shrink: 0; }

  /* KPIs */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; padding: 20px 30px; background: #f8f9fa; border-bottom: 2px solid #e9ecef; }
  .stat-card { background: white; padding: 14px 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); text-align: center; }
  .stat-card.total  { border-left: 4px solid #b71234; }
  .stat-card.var    { border-left: 4px solid #28a745; }
  .stat-card.mayor  { border-left: 4px solid #9B8942; }
  .stat-card h3 { font-size: 10px; color: #6c757d; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-card p  { font-size: 22px; font-weight: 700; color: #2f2f2f; }
  .stat-card .sub { font-size: 12px; margin-top: 3px; font-weight: 600; color: #6c757d; }
  .stat-card .sub.up { color: #28a745; }

  /* Secciones */
  .section { border-bottom: 1px solid #e9ecef; }
  .section-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 30px; cursor: pointer; background: white; transition: background 0.2s; user-select: none; }
  .section-header:hover { background: #fff5f7; }
  .section-header h2 { font-size: 16px; color: #b71234; font-weight: 700; display: flex; align-items: center; gap: 10px; }
  .section-header .arrow { font-size: 18px; color: #b71234; transition: transform 0.3s; }
  .section-header.open .arrow { transform: rotate(180deg); }
  .section-body { display: none; padding: 0 30px 30px; background: #fafafa; }
  .section-body.open { display: block; }

  /* Controles de vista */
  .view-toggles { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; padding-top: 20px; }
  .view-toggle { padding: 9px 18px; border: 2px solid #dee2e6; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.3s; font-family: inherit; }
  .view-toggle:hover { border-color: #b71234; background: #fff5f7; }
  .view-toggle.active { background: #b71234; color: white; border-color: #b71234; }

  /* Gr√°ficos */
  .chart-wrap { position: relative; height: 320px; background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  .chart-wrap.hidden { display: none; }

  /* Tabla */
  .table-wrap { overflow-x: auto; border: 1px solid #dee2e6; border-radius: 8px; margin-top: 20px; }
  table { width: 100%; border-collapse: collapse; background: white; font-size: 13px; }
  thead { background: linear-gradient(135deg, #b71234 0%, #8b0d27 100%); color: white; }
  th { padding: 10px 12px; text-align: left; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; }
  th.num { text-align: right; }
  td { padding: 9px 12px; border-bottom: 1px solid #e9ecef; }
  tbody tr:hover { background: #f8f9fa; }
  tbody tr:nth-child(even) { background: #fafafa; }
  tbody tr:nth-child(even):hover { background: #f0f0f0; }
  .td-num { text-align: right; font-weight: 600; font-variant-numeric: tabular-nums; white-space: nowrap; }
  .td-bold { font-weight: 700; background: #f0f0f0 !important; }
  .td-pos { color: #28a745; }
  .td-neg { color: #c0392b; }

  /* Footer */
  .footer { padding: 20px 30px; background: #e9ecef; color: #2f2f2f; text-align: center; font-size: 14px; }
  .footer a { color: #b71234; text-decoration: none; font-weight: 600; }
  .footer a:hover { text-decoration: underline; }

  @media (max-width: 768px) {
    body { padding: 10px; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .section-header { padding: 15px 20px; }
    .section-body { padding: 0 15px 20px; }
    .download-bar { padding: 12px 20px; }
  }
</style>
</head>
<body>
<div class="container">

  <div class="header">
    <h1>üí∞ Presupuesto de ingresos por cap√≠tulos ‚Äî 2024</h1>
  </div>

  <div class="download-bar">
    <span>üì• Descargar datos:</span>
    <button class="dl-btn xlsx" onclick="downloadXLSX()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      Excel (.xlsx)
    </button>
    <button class="dl-btn csv" onclick="downloadCSV()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      CSV
    </button>
  </div>

  <div class="stats-grid">
    <div class="stat-card total">
      <h3>Total Ingresos 2024</h3>
      <p>632,4 M‚Ç¨</p>
      <div class="sub">Presupuesto definitivo</div>
    </div>
    <div class="stat-card var">
      <h3>Variaci√≥n vs 2023</h3>
      <p>+14,4 M‚Ç¨</p>
      <div class="sub up">‚Üë +2,33%</div>
    </div>
    <div class="stat-card mayor">
      <h3>Mayor cap√≠tulo</h3>
      <p style="font-size:15px; margin-top:4px">Transf. Corrientes</p>
      <div class="sub">412,4 M‚Ç¨ ¬∑ 65,21%</div>
    </div>
  </div>

  <!-- SECCI√ìN 1: Distribuci√≥n -->
  <div class="section">
    <div class="section-header open" onclick="toggleSection(this)">
      <h2>üìä Distribuci√≥n por cap√≠tulo 2024</h2><span class="arrow">‚ñº</span>
    </div>
    <div class="section-body open">
      <div class="view-toggles">
        <button class="view-toggle active" onclick="switchChart('dist','doughnut',this)">‚≠ï Circular</button>
        <button class="view-toggle" onclick="switchChart('dist','bar',this)">üìä Barras</button>
      </div>
      <div class="chart-wrap" id="wrap-dist-doughnut"><canvas id="chart-dist-doughnut"></canvas></div>
      <div class="chart-wrap hidden" id="wrap-dist-bar"><canvas id="chart-dist-bar"></canvas></div>
    </div>
  </div>

  <!-- SECCI√ìN 2: Comparativa -->
  <div class="section">
    <div class="section-header open" onclick="toggleSection(this)">
      <h2>üìà Comparativa 2023 vs 2024</h2><span class="arrow">‚ñº</span>
    </div>
    <div class="section-body open">
      <div style="padding-top:20px">
        <div class="chart-wrap"><canvas id="chart-comparativa"></canvas></div>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN 3: Variaci√≥n -->
  <div class="section">
    <div class="section-header open" onclick="toggleSection(this)">
      <h2>‚ÜïÔ∏è Variaci√≥n porcentual por cap√≠tulo (2023‚Üí2024)</h2><span class="arrow">‚ñº</span>
    </div>
    <div class="section-body open">
      <div style="padding-top:20px">
        <div class="chart-wrap" style="height:260px"><canvas id="chart-variacion"></canvas></div>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN 4: Tabla -->
  <div class="section">
    <div class="section-header open" onclick="toggleSection(this)">
      <h2>üìã Detalle por cap√≠tulos</h2><span class="arrow">‚ñº</span>
    </div>
    <div class="section-body open">
      <div class="table-wrap" style="margin-top:20px">
        <table>
          <thead>
            <tr>
              <th>Cap√≠tulo</th>
              <th class="num">2024 (‚Ç¨)</th>
              <th class="num">% 2024</th>
              <th class="num">2023 (‚Ç¨)</th>
              <th class="num">% 2023</th>
              <th class="num">Variaci√≥n ‚Ç¨</th>
              <th class="num">Variaci√≥n %</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="footer">
    Datos facilitados por la <a href="https://www.ucm.es/directorio/?eid=962" target="_blank" rel="noopener">Vicegerencia Econ√≥mica</a> ¬∑ Portal de Transparencia ¬∑ <a href="https://www.ucm.es/portaldetransparencia/ingresos-y-gastos" target="_blank" rel="noopener">Universidad Complutense de Madrid</a>
  </div>

</div><!-- /container -->

<script>
const T24 = 632446485.67, T23 = 618023059.42;
const data = [
  { cap: 'III Tasas, precios p√∫blicos y otros ingresos', v24: 141242676.86, v23: 144662001.33, p24: 0.2233, p23: 0.2341 },
  { cap: 'IV Transferencias corrientes',                 v24: 412397966.02, v23: 404287285.77, p24: 0.6521, p23: 0.6542 },
  { cap: 'V Ingresos patrimoniales',                    v24: 7924585.68,   v23: 5547213.27,   p24: 0.0125, p23: 0.0090 },
  { cap: 'VI Enajenaci√≥n de inversiones reales',        v24: 500000,       v23: 225000,       p24: 0.0008, p23: 0.0004 },
  { cap: 'VII Transferencias de capital',               v24: 69201157.11,  v23: 62221259.05,  p24: 0.1094, p23: 0.1007 },
  { cap: 'VIII Activos financieros',                    v24: 1140000,      v23: 1050000,      p24: 0.0018, p23: 0.0016 },
  { cap: 'IX Pasivos financieros',                      v24: 40100,        v23: 30300,        p24: 0.0001, p23: 0.0000 },
];
const shortL = ['III Tasas','IV Transf. corrientes','V Patrimoniales','VI Enajenaci√≥n','VII Transf. capital','VIII Activos fin.','IX Pasivos fin.'];
const PAL    = ['#b71234','#9B8942','#007bff','#fd7e14','#28a745','#6c757d','#2980b9'];
const fmt    = n => new Intl.NumberFormat('es-ES',{minimumFractionDigits:2,maximumFractionDigits:2}).format(n);
const fmtP   = n => (n*100).toFixed(2)+'%';

// Doughnut
new Chart(document.getElementById('chart-dist-doughnut'),{
  type:'doughnut',
  data:{labels:shortL,datasets:[{data:data.map(d=>d.v24),backgroundColor:PAL,borderWidth:2,borderColor:'#fff',hoverOffset:8}]},
  options:{responsive:true,maintainAspectRatio:false,cutout:'60%',
    plugins:{legend:{position:'right',labels:{font:{size:11},padding:14,boxWidth:12}},
    tooltip:{callbacks:{label:c=>` ${fmt(c.raw)} ‚Ç¨ (${(c.raw/T24*100).toFixed(2)}%)`}}}}
});

// Bar distribuci√≥n
new Chart(document.getElementById('chart-dist-bar'),{
  type:'bar',
  data:{labels:shortL,datasets:[{label:'2024 (‚Ç¨)',data:data.map(d=>d.v24),backgroundColor:PAL,borderRadius:4}]},
  options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${fmt(c.raw)} ‚Ç¨`}}},
    scales:{x:{ticks:{font:{size:10}}},y:{ticks:{callback:v=>(v/1e6).toFixed(0)+' M‚Ç¨',font:{size:10}},grid:{color:'#f0f0f0'}}}}
});

// Comparativa
new Chart(document.getElementById('chart-comparativa'),{
  type:'bar',
  data:{labels:shortL,datasets:[
    {label:'2023',data:data.map(d=>+(d.v23/1e6).toFixed(3)),backgroundColor:'#dee2e6',borderRadius:4},
    {label:'2024',data:data.map(d=>+(d.v24/1e6).toFixed(3)),backgroundColor:PAL,borderRadius:4}
  ]},
  options:{responsive:true,maintainAspectRatio:false,
    plugins:{legend:{position:'top'},tooltip:{callbacks:{label:c=>` ${c.dataset.label}: ${c.raw} M‚Ç¨`}}},
    scales:{x:{ticks:{font:{size:10}}},y:{ticks:{callback:v=>v+' M‚Ç¨',font:{size:10}},grid:{color:'#f0f0f0'}}}}
});

// Variaci√≥n horizontal
const varD = data.map(d=>+((d.v24-d.v23)/d.v23*100).toFixed(2));
new Chart(document.getElementById('chart-variacion'),{
  type:'bar',
  data:{labels:shortL,datasets:[{label:'Variaci√≥n %',data:varD,backgroundColor:varD.map(v=>v>=0?'#28a745':'#c0392b'),borderRadius:4}]},
  options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${c.raw>0?'+':''}${c.raw}%`}}},
    scales:{x:{ticks:{callback:v=>v+'%',font:{size:10}},grid:{color:'#f0f0f0'}},y:{ticks:{font:{size:10}}}}}
});

// Tabla
const tb = document.getElementById('tableBody');
data.forEach(d=>{
  const vE=d.v24-d.v23, vP=(vE/d.v23*100), c=vE>=0?'td-pos':'td-neg', s=vE>=0?'+':'';
  tb.innerHTML+=`<tr><td>${d.cap}</td><td class="td-num">${fmt(d.v24)}</td><td class="td-num">${fmtP(d.p24)}</td><td class="td-num">${fmt(d.v23)}</td><td class="td-num">${fmtP(d.p23)}</td><td class="td-num ${c}">${s}${fmt(vE)}</td><td class="td-num ${c}">${s}${vP.toFixed(2)}%</td></tr>`;
});
tb.innerHTML+=`<tr class="td-bold"><td>Total</td><td class="td-num">${fmt(T24)}</td><td class="td-num">100,00%</td><td class="td-num">${fmt(T23)}</td><td class="td-num">100,00%</td><td class="td-num td-pos">+${fmt(T24-T23)}</td><td class="td-num td-pos">+2,33%</td></tr>`;

// UI
function toggleSection(h){ h.classList.toggle('open'); h.nextElementSibling.classList.toggle('open'); }
function switchChart(sec,view,btn){
  btn.closest('.section-body').querySelectorAll('.view-toggle').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  btn.closest('.section-body').querySelectorAll('.chart-wrap').forEach(w=>w.classList.add('hidden'));
  document.getElementById(`wrap-${sec}-${view}`).classList.remove('hidden');
}

// Descargas
function getRows(){
  const rows=data.map(d=>{const vE=d.v24-d.v23,vP=(vE/d.v23*100);return[d.cap,d.v24,(d.p24*100).toFixed(2)+'%',d.v23,(d.p23*100).toFixed(2)+'%',+vE.toFixed(2),vP.toFixed(2)+'%'];});
  rows.push(['Total',T24,'100,00%',T23,'100,00%',+(T24-T23).toFixed(2),'2,33%']);
  return rows;
}
function downloadXLSX(){
  const heads=['Cap√≠tulo','2024 (‚Ç¨)','% 2024','2023 (‚Ç¨)','% 2023','Variaci√≥n ‚Ç¨','Variaci√≥n %'];
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet([
    ['Universidad Complutense de Madrid ‚Äî Ingresos por Cap√≠tulos 2024'],
    ['Datos facilitados por la Vicegerencia Econ√≥mica (https://www.ucm.es/directorio/?eid=962)'],
    ['Fuente: Portal de Transparencia UCM (https://www.ucm.es/portaldetransparencia/ingresos-y-gastos)'],
    [],heads,...getRows()
  ]);
  ws['!cols']=[{wch:52},{wch:18},{wch:10},{wch:18},{wch:10},{wch:18},{wch:12}];
  ws['!merges']=[{s:{r:0,c:0},e:{r:0,c:6}},{s:{r:1,c:0},e:{r:1,c:6}},{s:{r:2,c:0},e:{r:2,c:6}}];
  XLSX.utils.book_append_sheet(wb,ws,'Ingresos 2024');
  XLSX.writeFile(wb,'UCM_Ingresos_Capitulos_2024.xlsx');
}
function downloadCSV(){
  const heads=['Cap√≠tulo','2024 (‚Ç¨)','% 2024','2023 (‚Ç¨)','% 2023','Variaci√≥n ‚Ç¨','Variaci√≥n %'];
  const q=v=>(typeof v==='string'&&(v.includes(';')||v.includes(',')))?`"${v}"`:v;
  const lines=['sep=;','Universidad Complutense de Madrid ‚Äî Ingresos por Cap√≠tulos 2024',
    'Datos facilitados por la Vicegerencia Econ√≥mica','Fuente: Portal de Transparencia UCM',
    '',heads.join(';'),...getRows().map(r=>r.map(q).join(';'))];
  const blob=new Blob(['\uFEFF'+lines.join('\r\n')],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='UCM_Ingresos_Capitulos_2024.csv';a.click();
}
</script>
</body>
</html>
